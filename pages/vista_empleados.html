<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Administrar Choferes</title>
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
    <div class="flex gap-4">

        <h1 class="text-3xl font-bold mb-6">Administrar Choferes</h1>



        <div class="mb-4 flex gap-4">
            <select id="selectCiudad" class="border px-3 py-2 rounded shadow w-full md:w-1/3">
                <option value="">Seleccione</option>
            </select>

            <input type="text" id="filtroNombre" placeholder="Filtrar por nombre" class="border px-3 py-2 rounded " />
            <select id="filtroActivo" class="border px-3 py-2 rounded w-40">
                <option value="">Todos</option>
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
            </select>
        </div>
    </div>


    <!-- Tabla de Choferes -->
    <table class="min-w-full bg-white rounded shadow overflow-hidden">
        <thead>
            <tr class="bg-blue-500 text-white text-left">
                <th class="px-4 py-2">ID Chofer</th>
                <th class="px-4 py-2">Nombre Completo</th>
                <th class="px-4 py-2">Activo</th>
                <th class="px-4 py-2">Fecha Nacimiento</th>
                <th class="px-4 py-2">Sueldo</th>
                <th class="px-4 py-2">Ciudad Asignada</th>
                <th class="px-4 py-2">Acciones</th>
            </tr>
        </thead>

        <tbody id="choferesTableBody">
            <!-- Choferes cargados dinámicamente -->
        </tbody>
    </table>

    <!-- Modal para modificar chofer -->
    <div id="modalModificar" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-30"></div>
        <div class="relative bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Modificar Chofer</h2>
            <form id="formModificar">
                <div class="mb-4">
                    <label for="modActivo" class="block font-medium text-gray-700">Activo</label>
                    <select id="modActivo" required class="w-full border px-3 py-2 rounded">
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modNombre" class="block font-medium text-gray-700">Nombre</label>
                    <input type="text" disabled id="modNombre" maxlength="15" required
                        class="w-full border px-3 py-2 rounded bg-gray-100 cursor-not-allowed opacity-70" />
                </div>
                <div class="mb-4">
                    <label for="modApellidoPaterno" class="block font-medium text-gray-700">Apellido Paterno</label>
                    <input type="text" disabled id="modApellidoPaterno" maxlength="15" required
                        class="w-full border px-3 py-2 rounded bg-gray-100 cursor-not-allowed opacity-70" />
                </div>
                <div class="mb-4">
                    <label for="modApellidoMaterno" class="block font-medium text-gray-700">Apellido Materno</label>
                    <input type="text" disabled id="modApellidoMaterno" maxlength="15" required
                        class="w-full border px-3 py-2 rounded bg-gray-100 cursor-not-allowed opacity-70" />
                </div>
                <div class="mb-4">
                    <label for="modFechaNacimiento" class="block font-medium text-gray-700">Fecha Nacimiento</label>
                    <input type="date" id="modFechaNacimiento" required class="w-full border px-3 py-2 rounded" />
                </div>
                <div class="mb-4">
                    <label for="modSueldo" class="block font-medium text-gray-700">Sueldo</label>
                    <input type="number" step="any" id="modSueldo" min="0" required
                        class="w-full border px-3 py-2 rounded" />
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" id="btnCancelarModificar"
                        class="px-4 py-2 bg-gray-400 rounded hover:bg-gray-500 text-white font-semibold">Cancelar</button>
                    <button type="submit" id="btnGuardarModificar"
                        class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-white font-semibold">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customAlert" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-30"></div>
        <div class="relative bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg max-w-sm w-full text-center">
            <p id="customAlertMessage" class="text-lg font-semibold"></p>
        </div>
    </div>


    <script>
        const choferesTableBody = document.getElementById('choferesTableBody');
        const modalModificar = document.getElementById('modalModificar');
        const formModificar = document.getElementById('formModificar');
        const modActivo = document.getElementById('modActivo');
        const modNombre = document.getElementById('modNombre');
        const modApellidoPaterno = document.getElementById('modApellidoPaterno');
        const modApellidoMaterno = document.getElementById('modApellidoMaterno');
        const modFechaNacimiento = document.getElementById('modFechaNacimiento');
        const modSueldo = document.getElementById('modSueldo');
        const btnCancelarModificar = document.getElementById('btnCancelarModificar');

        let choferes = [];
        let choferSeleccionado = null;

        const selectCiudad = document.getElementById('selectCiudad');

        async function cargarCiudades() {
            const res = await fetch('http://localhost:8080/api/ciudades');
            const ciudades = await res.json();
            selectCiudad.innerHTML = '<option value="">Seleccione</option>';
            ciudades.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.nombre;
                selectCiudad.appendChild(option);
            });
            selectCiudad.selectedIndex = 1;
            selectCiudad.dispatchEvent(new Event('change'));
        }

        async function cargarChoferesPorCiudad(ciudadId) {
            let url = 'http://localhost:8080/api/choferes'; // sin filtro, todos los choferes
            if (ciudadId && ciudadId.trim() !== '') { // si ciudadId NO está vacío
                url = `http://localhost:8080/api/choferes/filtrarPorCiudad/${ciudadId}`;
            }
            const res = await fetch(url);
            choferes = await res.json();
            renderTablaChoferes();
        }


        selectCiudad.addEventListener('change', () => {
            cargarChoferesPorCiudad(selectCiudad.value);
        });


        // Y al cargar la página:
        window.onload = async () => {
            await cargarCiudades(); // carga las ciudades en el select
            cargarChoferes(selectCiudad.value); // carga choferes filtrados por ciudad por defecto
        };



        function renderTablaChoferes() {
            choferesTableBody.innerHTML = '';
            choferes.forEach(chofer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="border px-4 py-2">${chofer.id}</td>
          <td class="border px-4 py-2">${chofer.nombre} ${chofer.apellidoPaterno} ${chofer.apellidoMaterno}</td>
          <td class="border px-4 py-2">${chofer.activo ? 'Sí' : 'No'}</td>
          <td class="border px-4 py-2">${new Date(chofer.fechaNacimiento).toLocaleDateString()}</td>
          <td class="border px-4 py-2">${chofer.sueldo.toFixed(2)}</td>
          <td class="border px-4 py-2">${chofer.ciudadAsignada.nombre}</td>
          <td class="border px-4 py-2 flex gap-2">
            <button class="bg-yellow-400 px-2 py-1 rounded text-sm" data-id="${chofer.id}" data-accion="modificar">Modificar</button>
            <button class="bg-red-600 px-2 py-1 rounded text-sm text-white" data-id="${chofer.id}" data-accion="eliminar">Eliminar</button>
          </td>
        `;
                choferesTableBody.appendChild(tr);
            });
        }

        const filtroNombre = document.getElementById('filtroNombre');
        const filtroActivo = document.getElementById('filtroActivo');

        function aplicarFiltros() {
            const nombreFiltro = filtroNombre.value.toLowerCase();
            const activoFiltro = filtroActivo.value;

            const filas = choferesTableBody.getElementsByTagName('tr');
            for (const fila of filas) {
                const nombreCompleto = fila.cells[1].textContent.toLowerCase();
                const activoTexto = fila.cells[2].textContent.toLowerCase();

                const coincideNombre = nombreCompleto.includes(nombreFiltro);
                const coincideActivo = activoFiltro === '' || (activoFiltro === 'true' && activoTexto === 'sí') || (activoFiltro === 'false' && activoTexto === 'no');

                if (coincideNombre && coincideActivo) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            }
        }

        filtroNombre.addEventListener('input', aplicarFiltros);
        filtroActivo.addEventListener('change', aplicarFiltros);

        const customAlert = document.getElementById('customAlert');
        const customAlertMessage = document.getElementById('customAlertMessage');

        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            // Opcional: autoocultar después de 3 segundos
            setTimeout(() => {
                customAlert.classList.add('hidden');
            }, 3000);
        }


        function mostrarModalModificar(chofer) {
            choferSeleccionado = chofer;
            modActivo.value = chofer.activo;
            modNombre.value = chofer.nombre;
            modApellidoPaterno.value = chofer.apellidoPaterno;
            modApellidoMaterno.value = chofer.apellidoMaterno;
            modFechaNacimiento.value = chofer.fechaNacimiento.split('T')[0];
            modSueldo.value = chofer.sueldo;
            modalModificar.classList.remove('hidden');
        }

        btnCancelarModificar.onclick = () => {
            modalModificar.classList.add('hidden');
            choferSeleccionado = null;
        };

        formModificar.onsubmit = async (e) => {
            e.preventDefault();

            const data = {
                activo: modActivo.value === 'true',
                nombre: modNombre.value,
                apellidoPaterno: modApellidoPaterno.value,
                apellidoMaterno: modApellidoMaterno.value,
                fechaNacimiento: modFechaNacimiento.value,
                sueldo: Number(modSueldo.value),
                ciudadId: choferSeleccionado.ciudadAsignada.id
            };

            try {
                const res = await fetch(`http://localhost:8080/api/choferes/${choferSeleccionado.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showCustomAlert('Chofer actualizado');
                    modalModificar.classList.add('hidden');
                    cargarChoferes();
                } else {
                    try {
                        const error = await res.json();
                        showCustomAlert(error.message);
                    } catch {
                        const errorText = await res.text();
                        showCustomAlert('Error al actualizar chofer: ' + errorText);
                    }
                }
            } catch (error) {
                showCustomAlert(error.message);
            }


        };

        function modalConfirm(message) {
            return new Promise((resolve) => {
                // Crear estructura modal si no existe
                let modal = document.getElementById('modalConfirm');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modalConfirm';
                    modal.innerHTML = `
                <div class="fixed inset-0 flex items-center justify-center z-50 ">
                    <div class="absolute inset-0 bg-black opacity-30"></div>
                    <div class="relative bg-white p-6 rounded shadow max-w-sm text-center">
                        <p id="modalConfirmMessage" class="mb-4"></p>
                        <button id="modalConfirmYes" class="mr-2 px-4 py-2 bg-blue-600 text-white rounded">Sí</button>
                        <button id="modalConfirmNo" class="px-4 py-2 bg-gray-400 rounded">No</button>
                    </div>
                </div>
            `;
                    document.body.appendChild(modal);
                }
                modal.querySelector('#modalConfirmMessage').textContent = message;
                modal.style.display = 'flex';

                const yesBtn = modal.querySelector('#modalConfirmYes');
                const noBtn = modal.querySelector('#modalConfirmNo');

                yesBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                noBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }


        choferesTableBody.onclick = async (e) => {
            const id = e.target.dataset.id;
            const accion = e.target.dataset.accion;
            if (accion === 'modificar') {
                const chofer = choferes.find(c => c.id == id);
                mostrarModalModificar(chofer);
            } else if (accion === 'eliminar') {
                const confirmado = await modalConfirm('¿Confirma que desea eliminar este chofer?');
                if (confirmado) {
                    try {
                        const res = await fetch(`http://localhost:8080/api/choferes/${id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            showCustomAlert('Chofer eliminado');
                            await cargarChoferesPorCiudad(selectCiudad.value); // corrige aquí
                        } else {
                            const error = await res.json();
                            showCustomAlert(error.message);
                        }
                    } catch (error) {
                        showCustomAlert(error.message);
                    }
                }
            }
        };



        window.onload = cargarChoferes;
    </script>
</body>

</html>